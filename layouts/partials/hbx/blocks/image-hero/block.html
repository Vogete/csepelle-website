{{/* Hugo Blox: Image Hero */}}
{{/* Documentation: https://hugoblox.com/blocks/ */}}
{{/* License: https://github.com/HugoBlox/hugo-blox-builder/blob/main/LICENSE.md */}}

{{/* Initialise */}}
{{ $page := .wcPage }}
{{ $block := .wcBlock }}
<div class="relative isolate px-6 pt-14 lg:px-8">

  <div class="mx-auto max-w-2xl {{if not ($block.design.no_padding | default false) }}py-32 sm:py-48 lg:py-56{{end}}">
    {{/* Get image from block content */}}
    {{ $image := "" }}
    {{ $image_filename := $block.content.image.filename | default "" }}
    {{ $image_path := "" }}

    {{ if $image_filename }}
      {{ $image_path = path.Join "media" $image_filename }}
      {{ $image = resources.GetMatch $image_path }}
    {{ end }}
    
    {{ if $image }}
      {{ if ne $image.MediaType.SubType "gif" }}
        {{ $responsive := partial "functions/process_responsive_image.html" (dict 
            "image" $image 
            "mode" "fit"
            "sizes" (slice 400 600 800 1200)
        ) }}
        <img class="mx-auto h-40 md:h-56 lg:h-64 mb-6" 
             srcset="{{ $responsive.srcset }}"
             sizes="(max-width: 768px) 100vw, 50vw"
             src="{{ $responsive.fallback.RelPermalink }}" 
             width="{{ $responsive.fallback.Width }}"
             height="{{ $responsive.fallback.Height }}"
             alt="{{$block.content.title | plainify}}">
      {{ else }}
        <img class="mx-auto h-40 md:h-56 lg:h-64 mb-6"
             src="{{$image.RelPermalink}}" 
             width="{{$image.Width}}"
             height="{{$image.Height}}"
             alt="{{$block.content.title | plainify}}">
      {{ end }}
    {{ else if $image_path }} {{/* This 'else if' will now correctly follow an 'if $image' */}}
      {{ errorf "%s uses the `image-hero` blox which specifies a non-existent `image` at `assets/%s`. Please add the image to this folder and try again." $page.File.Path $image_path }}
    {{ end }}

    {{/* Announcement text moved outside the main content div if it exists */}}
    {{ if $block.content.announcement.text }}
    {{ $announcement := $block.content.announcement }}
    <div class="hidden sm:mb-8 sm:flex sm:justify-center">
      <div class="relative rounded-full px-3 py-1 text-sm leading-6 text-gray-600 dark:text-gray-300 ring-1 ring-gray-900/10 dark:ring-gray-300 hover:ring-gray-900/20 dark:hover:ring-gray-400">
        {{$announcement.text | markdownify}} 
        {{if $announcement.link.text}}
          {{ $announcement_link := $announcement.link.url }}
          {{ $announcement_scheme := (urls.Parse $announcement_link).Scheme }}
          {{ if not $announcement_scheme }}
            {{/* Check if it's a hash fragment (page anchor) */}}
            {{ if hasPrefix $announcement_link "#" }}
              {{/* Keep hash fragments as-is */}}
              {{ $announcement_link = $announcement_link }}
            {{ else }}
              {{/* Apply relLangURL for relative paths */}}
              {{ $announcement_link = $announcement_link | relLangURL }}
            {{ end }}
          {{ end }}
          <a href="{{$announcement_link | safeURL}}" class="font-semibold text-primary-600 dark:text-primary-300">
            <span class="absolute inset-0" aria-hidden="true"></span>{{$announcement.link.text}} <span aria-hidden="true">&rarr;</span>
          </a>
        {{end}}
      </div>
    </div>
    {{end}}

    <div class="text-center"> {{/* This div correctly wraps title, text, and actions */}}
      {{ with $block.content.title }}<h1 class="text-4xl font-bold tracking-tight text-gray-900 dark:text-gray-100 sm:text-6xl">{{ . | markdownify }}</h1>{{end}}
      {{ with $block.content.text }}<p class="mt-6 text-lg leading-8 text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">{{ . | $page.RenderString | emojify }}</p>{{end}}

      {{ if $block.content.primary_action.url }}
        {{ $link := $block.content.primary_action.url }}
        {{ $scheme := (urls.Parse $link).Scheme }}
        {{ $target := "" }}
        {{ if not $scheme }}
          {{/* Check if it's a hash fragment (page anchor) */}}
          {{ if hasPrefix $link "#" }}
            {{/* Keep hash fragments as-is */}}
            {{ $link = $link }}
          {{ else }}
            {{/* Apply relLangURL for relative paths */}}
            {{ $link = $link | relLangURL }}
          {{ end }}
        {{ else if in (slice "http" "https") $scheme }}
          {{ $target = "target=\"_blank\" rel=\"noopener\"" }}
        {{ end }}
      <div class="mt-10 flex items-center justify-center gap-x-6">
        <a href="{{ $link | safeURL }}" {{ $target | safeHTMLAttr }} class="rounded-md bg-primary-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600">
          {{ $block.content.primary_action.text | markdownify | emojify }}
          {{ with $block.content.primary_action.icon }}
            {{ partial "functions/get_icon" (dict "name" . "attributes" "style=\"height: 1em\" class='inline-block pl-2'") }}
          {{ end }}
        </a>
        {{end}}

        {{ if $block.content.secondary_action.url }}
          {{ $link_alt := $block.content.secondary_action.url }}
          {{ $scheme_alt := (urls.Parse $link_alt).Scheme }}
          {{ $target_alt := "" }}
          {{ if not $scheme_alt }}
            {{/* Check if it's a hash fragment (page anchor) */}}
            {{ if hasPrefix $link_alt "#" }}
              {{/* Keep hash fragments as-is */}}
              {{ $link_alt = $link_alt }}
            {{ else }}
              {{/* Apply relLangURL for relative paths */}}
              {{ $link_alt = $link_alt | relLangURL }}
            {{ end }}
          {{ else if in (slice "http" "https") $scheme_alt }}
            {{ $target_alt = "target=\"_blank\" rel=\"noopener\"" }}
          {{ end }}
        <a href="{{ $link_alt | safeURL }}" {{ $target_alt | safeHTMLAttr }} class="text-sm font-semibold leading-6 text-gray-900 dark:text-gray-100 hover:dark:text-gray-200 hover:text-gray-800">{{ $block.content.secondary_action.text | markdownify | emojify }} <span aria-hidden="true">â†’</span></a>
      {{end}}

      </div>

    </div> {{/* closing div for text-center */}}
  </div>

</div>